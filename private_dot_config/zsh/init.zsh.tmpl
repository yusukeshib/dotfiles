bindkey -e
unsetopt BEEP

# Nix
if [ -e '/nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh' ]; then
  . '/nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh'
fi

export TERM=xterm-256color
export LANG=en_US.UTF-8
export LC_ALL=en_US.UTF-8
export FZF_DEFAULT_COMMAND='fd --type f -i'
export PATH="$HOME/.local/bin:$HOME/.cargo/bin:$PATH"
export PATH=$HOME/.opencode/bin:$PATH
{{ if eq .chezmoi.os "darwin" -}}
export SSH_AUTH_SOCK="$HOME/Library/Group Containers/2BUA8C4S2C.com.1password/t/agent.sock"
export REALM_DEFAULT_IMAGE=mydev:auth
export REALM_DOCKER_ARGS="-v $HOME/.claude/settings.json:/home/yusuke/.claude/settings.json -e ANTHROPIC_API_KEY -e GH_TOKEN"
{{ end }}
if type "nixy" > /dev/null; then
  eval "$(nixy config zsh)"
fi

#
# Plugins (must come before native integrations that use compdef)
#

source ${0:A:h}/plugins.zsh

#
# Native tool integrations
#

if ! [ "$STARSHIP_DISABLED" = "true" ] && type "starship" > /dev/null; then
  eval "$(starship init zsh)"
fi

if type "direnv" > /dev/null; then
  eval "$(direnv hook zsh)"
fi

if type "fzf" > /dev/null; then
  source <(fzf --zsh)
fi

if type "kubectl" > /dev/null; then
  source <(kubectl completion zsh)
fi

#
# Aliases
#

# eza
if type "eza" > /dev/null; then
  alias ls='eza'
  alias ll='eza -lg'
  alias la='eza -la'
  alias lt='eza --tree'
fi

if type "zellij" > /dev/null; then
  alias new="zellij -s"

  # Note: defining 'a' as a function is more stable
  a() { zellij attach "$@"; }

  _zellij_attach_sessions() {
    local -a sessions
    # Important: use `list-sessions` (not `ls`)
    sessions=("${(@f)$(zellij list-sessions --short 2>/dev/null)}")
    if (( ! $#sessions )); then
      _message 'no sessions'
      return 1
    fi
    compadd -S '' -Q -a sessions
  }

  # Bind completion function to 'a' (required)
  compdef _zellij_attach_sessions a

  # fzf-tab preview (optional)
  zstyle ':fzf-tab:complete:a:*' fzf-preview \
    'echo "Zellij session: $word"; echo; zellij list-sessions --short | grep --color=always -E "^${word//\*/.*}$" || true'
fi

if type "nvim" > /dev/null; then
  alias vi="nvim"
  alias vim="nvim"
  export EDITOR="nvim"
fi

if type "batcat" > /dev/null; then
  alias cat="batcat"
elif type "bat" > /dev/null; then
  alias cat="bat"
fi

if type "rg" > /dev/null; then
  alias rg="rg --hidden -g '!.git/'"
fi


if type "atuin" > /dev/null; then
  eval "$(atuin init zsh --disable-up-arrow)"
  bindkey '^r' atuin-search
fi

if type "wt" > /dev/null; then
  eval "$(wt config shell init zsh)";
fi

if type "docker" > /dev/null; then
  alias mydev_update="docker commit $(docker ps -q -f ancestor=mydev:auth) mydev:auth"
fi
